<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/style/index.css">
</head>

<body>
    <div class="header">
        <h1>Student List</h1>
    </div>

    <!-- form to add data -->
    <div class="form">
        <h3>Add Student Info</h3>
        <form action="" id="student-form">
            <input type="text" name="id" placeholder="Enter ID" required>
            <input type="text" name="name" placeholder="Enter name" required>

            <select name="course" id="select" required>
                <!-- trich to use  placeholder for select hidden in option -->
                <option value="" disabled selected hidden>Select a course</option>
                <option value="Python">Python</option>
                <option value="AIML">AIML</option>
                <option value="JAVA">JAVA</option>
                <option value="C++">C++</option>
                <option value="JAVASCRIPT">JAVASCRIPT</option>
            </select>
            <button id="add-btn" type="submit"> ADD </button>
        </form>

    </div>

    <div class="btn-cont">
        <button id="btn">View Student Data</button>
    </div>

    <div class="search-box">
        <input id="search" type="search" name="search" placeholder="Search here ...">
        <button id="Search-btn">
            search
        </button>
    </div>
    <div>
        <table>
            <!-- heading rows -->
            <thead class=" heading">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Course</th>
                    <th>Action</th>
                </tr>
            </thead>
            <!-- main table data -->
            <tbody id="student-data">
                <tr>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>

                </tr>
            </tbody>


        </table>
    </div>

</body>

<script>
    let student = document.getElementById("student-data");
    let btn = document.getElementById("btn")

    async function loadData() {
        const response = await fetch('http://localhost:3000/student');
        const data = await response.json();

        console.log(data);
        student.innerHTML = "";

        data.forEach(element => {
            console.log(element);
            row = ` <tr>
                <td>${element.id}</td>
                <td>${element.name}</td>
                <td>${element.course}</td>
               <td>
                    <button id="delete-btn" onclick="delete_student(${element.id})">
                        <img  src="./assets/delete.png" alt="">
                    </button>
                    
                </td>
                
             </tr>`

            student.innerHTML += row;
        });
    }

    btn.addEventListener("click", loadData);

    // Adding data from form
    const form = document.getElementById("student-form");
    const submit_btn = document.getElementById("add-btn");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formdata = new FormData(form);
        const Student = {
            id: formdata.get("id"),
            name: formdata.get("name"),
            course: formdata.get("course"),
        };

        console.log(Student);
        submit_btn.style.backgroundColor = "#ffa1a1";
        submit_btn.textContent = "Added";

        try {
            const response = await fetch("http://localhost:3000/student", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(Student),
            });

            // waiting for theresponse form backend in json 
            const data = await response.json();
            console.log(data);

            // Handle duplicate entry error safely
            if (data.message && data.message.errno === 1062) {
                alert(data.message.sqlMessage);
            } else {
                console.log("Student added successfully!");
                // Reset form only after success
                form.reset();
                // Refresh table
            loadData();
            }

            // Always restore button state after everything
            setTimeout(() => {
                submit_btn.style.backgroundColor = "";
                submit_btn.textContent = "Add";
            }, 1500);

            
        } catch (err) {
            console.error("Error in updating the data:", err.message);
        }
    });

    // delete action
    const dlt_btn = document.getElementById("delete-btn");

    // function to delete the student entries
    async function delete_student(id) {

        // confirm message before deletion
        if (!confirm("Are you sure you want to delete this entry ")) return;

        //this  function sends the htto request to the backend with the id of students at this url 
        const response = await fetch(`http://localhost:3000/student/${id}`, {
            method: 'DELETE'
        })

        // the message send by the backend after deletion store in this variable
        const data = await response.json();
        console.log(data.message);

        // reload the show data function
        loadData();
    }

    // search 
    const Search = document.getElementById("search");
    const search_btn = document.getElementById("Search-btn");

    async function search() {

        const response = await fetch(`http://localhost:3000/student/search?q=${Search.value}`);
        const data = await response.json();
        console.log(data);
        // console.log(Search.value)

        student.innerHTML = "";

        // to check whether record found or not
        if (data.length != 0) {
            data.forEach(element => {
                console.log(element);
                row = ` <tr>
                <td>${element.id}</td>
                <td>${element.name}</td>
                <td>${element.course}</td>
               <td>
                    <button id="delete-btn" onclick="delete_student(${element.id})">
                        <img  src="./assets/delete.png" alt="">
                    </button>
                    
                </td>
                
             </tr>`

                student.innerHTML += row;
            })
        } else {
            console.log("no record found ...")
            alert("No record Found");
        }

    }

    search_btn.addEventListener("click", search);
</script>

<!-- <script src="../script/index.js"></script> -->

</html>